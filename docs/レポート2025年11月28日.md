こんにちは — 現状のコードベースと要件定義・実装計画が整合しているか、未達項目や関係ないキーワードが混入していないかを系統的にチェックします。まずは作業計画を立て、重要なファイルをスキャンして差分・未実装箇所を洗い出します。

開始 (レビュー報告書作成/4) *4*

Perfect — 調査をまとめて具体的な差分と次アクションの提案を作ります。次はレビュー報告書を作り、優先度の高い修正案を提示します。

ToDo リストを更新しました

## ✅ 全体サマリ（要点）
短くまとめると：
- 実装計画（implementation_plan.md / task.md）とコードベースは大部分で整合しています。
- 既に RED→GREEN された箇所（例：プロフィール作成の Server Action、createProfile のユニット／UI テスト、国作成処理）は実装・テスト済みです。
- 一方で、実装計画に「未完了」と残ったままの項目（RBAC サービス層・ACL シード等）が未実装、またコード / コメントの間に小さな不一致（profile_links insert の扱い等）があるため、計画ファイルの更新と小修正が必要です。

---

## 🔎 詳細レビュー（機能別）
以下は「実装状況」「テスト状況」「差分・注意点」「推奨アクション」を項目別に整理したものです。

### 1) プロフィール作成（Profile）
- ファイル / 流れ（主なもの）
  - UI: page.tsx → `CreateProfileForm` コンポーネント
  - UI wrapper: CreateProfileForm.tsx
  - クライアントラッパー: CreateProfileForm.fetch.ts
  - API: route.ts
  - サーバー / コア: createProfile.fetch.ts
  - ロジック: createProfile.logic.ts
  - テスト: createProfile.fetch.test.ts, create-profile.test.ts（RED→GREEN）, UI テスト CreateProfileForm.test.tsx

- 状態
  - 実装：実装済み（Server Action、API、UI、テストが存在）
  - テスト：ユニット・UIテストが揃っている（多く GREEN）／RED テストも残してあることで TDD 運用を反映

- 差分 / 注意点
  - DB スキーマ（schema.ts）には `profileLinks` が定義済み / マイグレーション 0005_profile_links.sql あり。
  - ただし createProfile.fetch.ts 内ではリンク保存箇所に “schema not modeled yet” とコメントがあり、`await db.insert({} as any)` のように未整備の挿入を行っている（実際の `profileLinks` テーブルを使っていない）。
  - → 「DB スキーマはあるが実装が差分」といった不一致あり。

- 推奨アクション
  - createProfile.fetch.ts を `profileLinks` テーブルを用いて正しく insert するよう実装を更新
  - 該当変更に合わせてユニットテストを少し修正（DBモックの期待を profileLinks に合う形に）
  - implementation_plan.md / task.md の該当箇所（Server Action の未実装表記）を実装済みに更新

---

### 2) 作品（Works）／マスタデータ・シード
- 状態
  - works + values のシードは 04_works.sql / 01_reference.sql 等へ統合済み。
  - package.json にシード実行スクリプトあり（`pnpm db:seed` の記述あり） — 仕様どおり。

- 推奨
  - 継続 (完了しているため大きな対応不要)

---

### 3) 国（Nation）作成フロー
- 状態
  - createNation.fetch.ts 実装済み（トランザクション処理含む）・ロジック create.logic.ts とテストあり。
  - 要件の多く（ポイント検証、トランザクション、招待/有効期限のテスト等） はカバーされている。

- 推奨
  - 継続的に既存テストのカバレッジを拡大（参加/任命/国庫管理など未実装の要素は残る）

---

### 4) RBAC（アクセス権限）周り
- 状態
  - DB スキーマはかなり網羅（schema.ts に `acl_permissions`, `acl_roles`, `acl_role_permissions`, `acl_groups`, `acl_group_closure` 等が定義）および SQL マイグレーション（例 0004_yellow_betty_ross.sql）あり。
  - 但し、重要な未実装要素：
    - ACL シード（期待される `supabase/seed/05_acl_permissions.sql` が存在しない）
    - RBAC サービス層（`src/lib/auth/rbac-service.ts` 等）が未実装
    - `exception-grants` や `user_authorization_permissions`（マテビュー再計算ロジックなど）が未整備
    - `hasPermission` / `requirePermission` の TDD 実装が未完

- リスク
  - スキーマはあるがサービス層や運用ルールが無いと、実際の運用／RLS（Row Level Security）に結びつかない

- 推奨
  - 優先で行う作業：
    1. ACL シードファイルを作成（要件で規定する権限カタログを SQL で投入）
    2. `rbac-service.ts` を設計してテストから実装（mergeSystemRoles, applyDenyRules など）
    3. `hasPermission` / `requirePermission` を TDD で実装
    4. `user_authorization_permissions` の再計算ロジックやマテビュー、RLS ポリシーの整備

---

### 5) ビルドの失敗（注意点）
- 状況
  - ローカル `pnpm run build` build_log.txt を確認）。
  - 失敗の主原因：`src/_sample/...` 内のサンプルページが、存在しない `components_sample/AI/v0/...` をインポートしており型解決失敗 → Next ビルドが中断。
- 推奨
  - 2つの選択肢：
    - サンプルコンテンツをビルドの対象から外す（Next config / route manifest対応、もしくは `src/_sample` をビルド対象外に）
    - サンプルの import を修正して欠落コンポーネントを追加 or import を外す
  - CI/Build 時にサンプルを除外する設定を入れれば、本線のビルド安定化に即効性あり

---

### 6) 「要件定義書に載ってないワード」 / その他雑多な要素
- 見つかったもの
  - マイグレーションファイル名にユニークかつ物語的な名前（例: `0000_gigantic_agent_brand.sql`, `0002_graceful_starjammers.sql`, `0003_dizzy_ender_wiggin.sql`, 0004_yellow_betty_ross.sql） → 要件書に明記は無い。機能には影響しないが可読性の観点で整理可能。
  - `src/_sample` に AI サンプルや non-production コンテンツあり（ビルド不具合の原因）。
- 対応案
  - migration 名の正規化は任意（必要なら `meta/` に説明を付ける）
  - `src/_sample` を docs や `samples/` に移動、もしくはビルド対象除外

---

## 🎯 優先度付き「次にやること」提案（短期・中期）
短く実行順（高→低）で推奨タスクを記載します。

1. 高（すぐやる）
   - 実装計画（implementation_plan.md / task.md）を現状（Server Action 実装済等）に合わせて更新する。
     - 理由：ドキュメントが古いと現状判断ミスや重複工数が発生します。
2. 高（バグ/品質）
   - createProfile.fetch.ts の profileリンク挿入を `profileLinks` テーブルを使うよう修正 + テスト更新。
3. 高（ビルド安定化）
   - `src/_sample` のビルド除外 or サンプル import 修正（現在の `next build` を成功させるために最優先で対応推奨）。
4. 中（機能）
   - RBAC 周りの「シード追加」「rbac-service の TDD 実装」「hasPermission/requirePermission の実装・テスト」を着手。
5. 中・低（改善）
   - マイグレーション名や雑多ファイルの整理／ドキュメント追記（レビュー容易化）

---

## 🔧 もし私が作業する場合（提案：短い PR 内容）
- 変更 #1（短時間）
  - 修正対象: createProfile.fetch.ts
  - 目的: profile link 挿入を `profileLinks` テーブルへ書き込むように変更してテストを green にする
  - テスト: createProfile.fetch.test.ts の Mock が期待する `db.insert` の引数を `profileLinks` に合わせる
- 変更 #2（非常に短時間）
  - 修正対象: CI / next build のブロックを引き起こす `src/_sample/*` の import を修正 or `next.config` で route/exclude を追加
- 追加タスク（中期）
  - Add `supabase/seed/05_acl_permissions.sql` と RBAC の初期ロールシード
  - `src/lib/auth/rbac-service.ts` の TDD実装

ご希望なら、上位 2つ（profile_links 修正 + build のサンプル除外）を実装してすぐ PR（もしくはコミット）します。どちらを先に進めますか？

---

## 📌 最後に（Wrap-up）
- 状況は総じて良好で、TDD の流れが機能しています（RED/GreenテストとUIテストがある点が良い）。
- 優先すべきは「小さな整合性の修正（profile_links）」「ビルド安定化（samples）」「RBAC のサポート整備（シード・サービス）」です。
- 次回アクションの選択を教えてください — 私が実装作業を進められます（まずは profile_link の修正 or build fix）。

💡 Tips: 実装計画が部分的に古いままだと見落としが出ます。まずドキュメントを最新化して *事実（実コード）＝計画* の状態を作るのが長期的に効率良いです。
