# 実装計画 (implementation_plan.md)

更新日: 2025-12-04

この文書は「masakinihirota」プロジェクトの実装を進めるための実践的な計画書です。
設計リポジトリ内の要件定義書／設計書を基に、MVP 実装の優先順位、フェーズ分割、テスト指針 (TDD)、コロケーション方針を明確化します。

---

## 📊 現状サマリー（2025-12-04 更新）

### 完了済み機能
| カテゴリ | 状況 | 詳細 |
|---------|------|------|
| 認証基盤 | ✅ 完了 | Supabase OAuth (Google)、middleware.ts 設定 |
| プロフィール | ✅ 完了 | 表示/編集 UI、CRUD API、profileLinks（外部連携） |
| コミュニティ | ✅ 完了 | 組織作成/一覧、organizationMembers ロール管理 |
| ポイント経済 | ✅ 完了 | 履歴、トランザクション、残高、ledgerEntries（二重記帳） |
| RBAC基盤 | ✅ 完了 | acl_* スキーマ、computeMergedPermissions |
| 管理者UI | ✅ 完了 | スケルトン (dashboard/users/contents/penalties/system) |
| HONO API | ✅ 完了 | REST API 全エンドポイント (/api/v1/*) |
| UIコンポーネント | ✅ 完了 | 90以上のページ、179テストファイル |
| URL設計書対応 | ✅ 完了 | 公開組織、リスト、建国申請、通報など (Task 6.1-6.2) |
| 作品評価 | ✅ 完了 | ティア評価、スキ/拍手、履歴 (Task 7.2-7.3) |
| マッチング | ✅ 完了 | 価値観スコア、自動候補保存、条件検索 (Task 8.1-8.3) |
| 国機能 | ✅ 完了 | 建国、徴収、常駐、調停者、銀行 (Task 9.1-9.3) |
| シードデータ | ✅ 完了 | master.ts、dummy.ts、runner.ts (Task 10.3) |
| ログ・監査 | ✅ 完了 | 構造化ロガー、audit()、time() (Task 11.2) |
| エラーハンドリング | ✅ 完了 | AppError階層、formatErrorResponse (Task 11.3) |
| チュートリアル | ✅ 完了 | TutorialStatus、KingDialog、機能解放 (Task 12.1) |

### テスト状況
- **Test Files**: 179 passed | 11 skipped (190)
- **Tests**: 816 passed
- **Coverage**: 単体テスト完備、DB統合テストはローカル実行

### 要件定義書との適合レビュー（2025-12-04 更新）
全体要件定義書（0001-01-全体要件定義書.md）との照合結果：
- **セクション 2.1.1-2.1.7**: 全項目実装完了
- **ゲーミフィケーション設計書**: ロジック・**UI統合完了**（Task 12.4完了）
- **UI設計書 0054-02**: 手動マッチング詳細UIは部分実装（フェーズ6で対応予定）

---

## 要約（目的） ✅

- 早期に価値を提供できる MVP を TDD で実装する
- 最小限の機能を短いイテレーションでデリバリする
- 価値観ベースのマッチングを核とした「国・組織・プロフィール」の連携を実現

---

## リリースフェーズ（高レベル） 📦

### フェーズ 0 — 準備（✅ 完了）
- 開発環境の標準化（ローカル Supabase）
- TDD 用テンプレート (Vitest) 整備

### フェーズ 1 — コア MVP（✅ 完了）
- ユーザ登録 / ログイン（Google OAuth）
- プロフィールの基本表示/編集
- コミュニティ（組織）の作成と表示

### フェーズ 2 — ポイント経済（✅ 完了）
- ポイント付与/消費の最小限フロー
- トランザクション整合性確認

### フェーズ 3 — 管理者機能・RBAC（✅ 完了）
- [x] 管理者用ページスケルトン
- [x] RBAC 基盤（computeMergedPermissions）
- [x] 管理者ロールチェック middleware 実装 (*開発中は無効化*)
- [x] Server Component での二重チェック (*開発中は無効化*)

### フェーズ 4 — 機能拡張（✅ 完了）
- [x] 作品評価機能の強化（ティア、スキ/拍手）
- [x] マッチング機能強化（スコア計算、自動候補）
- [x] 国機能（建国、常駐管理、調停者、銀行）
- [x] シードデータ整備
- [x] ログ・監査出力
- [x] エラーハンドリング統一
- [x] チュートリアル導線

### フェーズ 5 — UI/UX改善（🔄 一部完了）
- [x] Lv制UIへの統合（メニュー段階的解放）✅
- [ ] レスポンシブ対応強化
- [ ] 検索機能改善

### フェーズ 6 — 高度なUI機能（📋 計画中）
- [ ] 手動マッチング詳細UI（案件管理、候補選定、提案・合意）
- [ ] マップシステム（2Dグリッド）

---

## 技術スタック

| カテゴリ | 技術 |
|---------|------|
| Frontend | Next.js 15.5.6 (App Router) |
| UI | Tailwind CSS v4, Shadcn/UI |
| Database | PostgreSQL (Supabase Local) |
| ORM | Drizzle ORM |
| Auth | Supabase Auth (Google OAuth) |
| API | HONO 4.10.7 + Zod Validator |
| Testing | Vitest + React Testing Library |
| Deployment | Vercel (予定) |

---

## TDD とコロケーション方針（必須）🧪

- 全ての新規 UI コンポーネント / ビジネスロジックはテストファーストで作成
- RED → GREEN → REFACTOR サイクルを厳守
- コンポーネント単位で近くにテストファイルを配置
  - 例: `Component.tsx` と同ディレクトリに `Component.test.tsx`

---

## 次のアクション（短期）▶️

### 優先度: 高
1. **Task 12.2**: レスポンシブ対応の強化
   - モバイルナビゲーション改善（ハンバーガーメニュー）
   - テーブル表示のモバイル最適化
   - フォーム入力のタッチ最適化

### 優先度: 中
2. **Task 12.3**: 検索機能の改善
   - 全文検索インデックス追加
   - 検索結果ハイライト
   - 検索フィルタUI改善

### 優先度: 低
3. **Task 13.1-13.4**: 手動マッチング詳細UI（UI設計書 0054-02）
   - 案件管理、候補選定、提案・合意、監査ログUI

---

## セキュリティ・運用注意点 🔒

- OAuth シークレットや DB 接続情報は `.env` で管理（リポジトリ含めない）
- RLS / RBAC の設計は早期に検討（段階的に実装）
- 管理者権限は middleware + Server Component で二重チェック

---

## 参照ドキュメント

- `tasks.md` — 詳細タスクリスト
- `vns-masakinihirota-design/` — 設計書・要件定義書
- `docs/` — 機能別ドキュメント

---

質問や優先事項の変更があれば教えてください — 計画を調整します。
