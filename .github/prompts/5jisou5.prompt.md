---
description: 実装（厳格なTDD：RED-GREEN-REFACTORサイクル）
agent: agent
tools:
  [
    "changes",
    "chrome-devtools/*",
    "context7/*",
    "edit",
    "extensions",
    "fetch",
    "githubRepo",
    "new",
    "next-devtools/*",
    "openSimpleBrowser",
    "Postgres(LOCAL-supabase)/*",
    "problems",
    "runCommands",
    "runNotebooks",
    "runSubagent",
    "runTasks",
    "runTests",
    "search",
    "sequentialthinking/*",
    "serena/*",
    "supabase/deploy_edge_function",
    "supabase/execute_sql",
    "supabase/generate_typescript_types",
    "supabase/get_edge_function",
    "supabase/list_tables",
    "supabase/search_docs",
    "testFailure",
    "todos",
    "unsplash/*",
    "usages",
    "vscodeAPI",
  ]
---

このプロンプトは `masakinihirota` リポジトリ上で **TDD（RED→GREEN→REFACTOR）** を厳格に実践するためのエージェント実行指示です。
実装は必ず最小単位に留め、コロケーション規約を守り、1 作業単位につき「失敗するテストを必ず 1 つだけ追加する」ことを強制してください。

## 目的

IMPORTANT: このプロンプトは **Phase 5: ユーザープロフィール管理** にのみ適用されます。
他の Phase (Phase 1, Phase 2, Phase 3, Phase 3.5, Phase 4) には一切手を出さないでください。
すべての変更・テスト・ドキュメント更新は `Phase 5` に関連するファイルと `task.md` / `implementation_plan.md` の該当項目に限定してください。

## 最重要ルール（必ず守る）

1.  **最小の失敗テストを 1 つだけ追加する（RED）**:
    - 一度の変更で追加してよい「失敗するテストケース」は必ず **1 つのみ** です。
    - 複数のテストを一気に追加したり、最初からパスするテストを追加することは禁止します。
2.  **TDD サイクルを守る**: RED（失敗確認）→ GREEN（実装して成功）→ REFACTOR（整理）の順序を厳守してください。
3.  **コロケーション**: テストは実装ファイルと同じディレクトリに配置してください（例: `src/components/Foo/Foo.test.tsx`）。
4.  **DB テスト**: ユニット／UI テストは常に実行しますが、DB 統合テストはローカル Supabase 環境（`RUN_DB_TESTS=1`）でのみ実行してください。
5.  **アトミック性**: 1 変更で複数の独立機能を同時に追加しないでください。

## 実行手順（必須フロー）

1.  **要件特定**: `implementation_plan.md` / `task.md` を読み、次に実装すべき「最小の機能単位」を特定する。

2.  **RED（テスト作成）**:

    - 最小の失敗テストケースを **1 つだけ** `src/.../<Target>.test.(ts|tsx)` に追加する。
    - `runTests` を実行する。
    - **検証**:
      - 追加したテストが **期待通りに失敗すること** を確認する。
      - もしテストがパスしてしまった場合は、テストコードが間違っているか、テスト対象が適切でないため、修正する。
      - コンパイルエラー（型エラー等）でテストが実行できない状態は RED とみなさない。最低限テストが走る状態（スタブ作成など）にしてから失敗させること。

3.  **GREEN（実装）**:

    - `edit` で最小限の実装を追加し、`runTests` を再実行して該当テストをパスさせる。
    - この段階ではコードの美しさよりも「テストを通すこと」を優先してよい。

4.  **REFACTOR（リファクタリング）**:

    - テストが通った状態で、可読性向上・重複排除・型安全性の改善を行う。
    - 必要な場合、`supabase/generate_typescript_types` を実行して型定義を更新する。
    - **重要**: 機能（振る舞い）を変えてはならない。リファクタリング後に再度 `runTests` を行い、全てのテストが GREEN であることを確認する。

5.  **自動チェックとレビュー**:

    - 静的解析（`lint` / `biome` 等）を実行し、問題がないか確認する。
    - 自身の変更に対し、以下の観点で自己レビューを行う:
      - 新規に追加された「失敗 → 成功」したテストケースは 1 つか？
      - 既存の他のテストを壊していないか（回帰テスト）？
      - `implementation_plan.md` の要件を満たしているか？

6.  **完了記録**:
    - 問題がなければ、`serena/*` を使用して作業ログ、変更ファイル一覧、RED→GREEN の証跡を残す。
    - 完了したタスクがあれば `implementation_plan.md` や `task.md` にチェックマークを入れてください。
    - ユーザーには問題が発生するなどのトラブルがない限り実装すべき項目が終わるまで指示を仰ぐのは禁止。
    - まだ実装すべき項目が残っている場合は、次の TDD サイクルへ進む。

## 出力フォーマット（完了時）

以下の情報を構造化して出力すること：

1.  **変更ファイル一覧**（フルパス）
2.  **TDD 実行ログ要約**:
    - 追加したテスト名: `Describe > It should ...`
    - RED 時のエラーメッセージ抜粋
    - GREEN 時の成功確認
3.  **実装内容の要約**（1-3 行）
4.  **次アクションの提案**:
    - 次に実装すべきテストケースの提案
    - または、残作業の確認

## ガードレール（自動チェック）

- エージェントは `testFailure` ツールまたはテスト実行ログの解析を通じて、「今回追加された失敗テスト数が 1 であること」を常に監視してください。

## タスク整合性ルール（必須）

実装と `implementation_plan.md` / `task.md` のチェックマークが一致していないことは混乱の元です。以下のルールを必ず守ってください。

1. 実装後の検証

   - RED→GREEN→REFACTOR の各サイクルが完了したら、必ず `implementation_plan.md` と `task.md` を確認し、該当する項目のチェックマークが現実の実装状態を正しく反映していることを確認してください。
   - もしチェックマークが事実と異なる場合（未実装なのにチェックが入っている、実装済みなのにチェックがない等）は、修正（チェックの追加/除去）を行い、その理由をコミットメッセージと `serena` の作業ログに残してください。

2. 指示が不足している場合の対応

   - `implementation_plan.md` や `task.md` に「次に何をするか」の記述がない、もしくは曖昧な場合は、この `jisou.prompt.md` に短く明確な実行指示（1〜2 行）を追記してください。指示は日本語で、目的と最小の RED テストを書いた後の次アクションを示すこと。
   - 追記した指示は TDD の流れ（RED→GREEN→REFACTOR）で実施可能であることを確認し、対応するテスト／実装ファイルパスも併記してください。

3. ドキュメント編集の運用ルール
   - ドキュメント（`implementation_plan.md` / `task.md` / `jisou.prompt.md`）の変更は必ず小さなコミットで行い、変更理由を説明するコミットメッセージを付してください。
   - 変更によってテストや CI に影響がある場合は、必ずローカルでテストを実行してからコミットしてください。

これらのルールを守ることで、実装状況とタスクリストを一貫して保てます。
