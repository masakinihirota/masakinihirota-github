---
description: リファクタリング（振る舞いを保持した品質改善）
agent: agent
tools:
  [
    "changes",
    "chrome-devtools/*",
    "context7/*",
    "edit",
    "extensions",
    "fetch",
    "githubRepo",
    "new",
    "next-devtools/*",
    "openSimpleBrowser",
    "Postgres(LOCAL-supabase)/*",
    "problems",
    "runCommands",
    "runNotebooks",
    "runSubagent",
    "runTasks",
    "search",
    "sequentialthinking/*",
    "serena/*",
    "supabase/deploy_edge_function",
    "supabase/execute_sql",
    "supabase/generate_typescript_types",
    "supabase/get_edge_function",
    "supabase/list_tables",
    "supabase/search_docs",
    "testFailure",
    "todos",
    "unsplash/*",
    "usages",
    "vscodeAPI",
  ]
---

このプロンプトは `masakinihirota` リポジトリ上で **リファクタリング（振る舞いを保持した品質改善）** を安全に実施するためのエージェント実行指示です。
リファクタリングは「外部から見た振る舞いを変えずに内部構造を改善する」作業です。必ずテストが GREEN の状態で開始し、GREEN のまま終了してください。

## 目的

このプロンプトは `masakinihirota` リポジトリ上でリファクタリングを実施するためのエージェント実行指示です。

IMPORTANT: リファクタリングでは **機能追加や仕様変更を行わない** ことを厳守してください。

## 最重要ルール（必ず守る）

1. **GREEN から始めて GREEN で終わる**:

   - リファクタリング開始前に必ず `runTests` を実行し、全テストが GREEN であることを確認する。
   - リファクタリング中も頻繁にテストを実行し、RED になったら即座にロールバックまたは修正する。
   - 最終的に全テストが GREEN であることを確認してから完了とする。

2. **振る舞いを変えない**:

   - 外部から見た入出力、API、UI の動作を変更してはならない。
   - 型シグネチャの変更は慎重に行い、呼び出し元への影響を必ず確認する。

3. **小さなステップで進める**:

   - 1 回の変更は 1 つの改善に限定する（例: 関数の抽出、変数名の変更、重複の排除など）。
   - 各ステップ後にテストを実行して GREEN を維持する。

4. **コロケーション規約を維持**:
   - ファイル移動時はテストファイルも一緒に移動する。
   - import パスの更新漏れがないか確認する。

## リファクタリングの種類と手順

### 1. コード品質改善

| 改善項目                     | 手順                                                                      |
| ---------------------------- | ------------------------------------------------------------------------- |
| **変数名・関数名の改善**     | 1. Serena の `rename_symbol` を使用 2. テスト実行 3. 関連ドキュメント更新 |
| **マジックナンバーの定数化** | 1. 定数を定義 2. 置換 3. テスト実行                                       |
| **関数の抽出**               | 1. 新関数を作成 2. 元のコードを新関数呼び出しに置換 3. テスト実行         |
| **重複コードの排除（DRY）**  | 1. 共通部分を抽出 2. 各箇所を共通化 3. テスト実行                         |

### 2. 構造改善

| 改善項目             | 手順                                                             |
| -------------------- | ---------------------------------------------------------------- |
| **ファイル分割**     | 1. 新ファイル作成 2. コード移動 3. import 更新 4. テスト実行     |
| **ディレクトリ整理** | 1. 新構造を計画 2. ファイル移動 3. import 一括更新 4. テスト実行 |
| **型定義の整理**     | 1. 型を適切な場所に移動 2. export/import 更新 3. テスト実行      |

### 3. パフォーマンス改善

| 改善項目                     | 手順                                                                    |
| ---------------------------- | ----------------------------------------------------------------------- |
| **メモ化の追加**             | 1. `useMemo`/`useCallback` を追加 2. 依存配列を正しく設定 3. テスト実行 |
| **不要な再レンダリング防止** | 1. コンポーネント分割 2. `React.memo` 適用 3. テスト実行                |
| **バンドルサイズ最適化**     | 1. dynamic import 導入 2. 不要な依存関係削除 3. ビルド確認              |

## 実行手順（必須フロー）

1. **事前確認（GREEN 確認）**:

   ```
   pnpm run test
   pnpm run lint
   pnpm run build
   ```

   - すべてが成功していることを確認する。失敗がある場合はリファクタリングを開始しない。

2. **スコープ特定**:

   - リファクタリング対象を明確にする（ファイル、関数、コンポーネントなど）。
   - Serena の `get_symbols_overview` や `find_symbol` を使用してコード構造を把握する。
   - 影響範囲を `find_referencing_symbols` で確認する。

3. **小さな変更を適用**:

   - 1 つの改善を実施する。
   - Serena の symbolic editing tools（`replace_symbol_body`, `rename_symbol` など）を活用する。

4. **テスト実行（GREEN 維持）**:

   ```
   pnpm run test
   ```

   - RED になった場合は即座に修正するか、変更を元に戻す。

5. **繰り返し**:

   - 手順 3-4 を改善が完了するまで繰り返す。

6. **最終確認**:

   ```
   pnpm run test
   pnpm run lint
   pnpm run build
   ```

   - すべてが成功していることを確認する。

7. **完了記録**:
   - `serena/*` を使用して作業ログを残す。
   - 変更内容をコミットする。

## 出力フォーマット（完了時）

以下の情報を構造化して出力すること：

1. **リファクタリング種別**: （コード品質改善 / 構造改善 / パフォーマンス改善）
2. **変更ファイル一覧**（フルパス）
3. **改善内容の要約**:
   - Before: 変更前の問題点
   - After: 変更後の改善点
4. **テスト結果**:
   - 開始時: GREEN（○ 件パス）
   - 完了時: GREEN（○ 件パス）
5. **次の改善候補**（任意）

## ガードレール（自動チェック）

- **テスト数の変化なし**: リファクタリングではテストケース数が増減しないことが原則。
- **カバレッジ維持**: カバレッジが下がっていないことを確認する。
- **型エラーなし**: `tsc --noEmit` でエラーがないことを確認する。
- **lint エラーなし**: `eslint` でエラーがないことを確認する。

## 禁止事項

- ❌ テストが RED の状態でリファクタリングを開始すること
- ❌ 機能追加や仕様変更を「リファクタリング」と称して行うこと
- ❌ テストなしでリファクタリングを行うこと
- ❌ 大きな変更を一度に行うこと（小さなステップを守る）
- ❌ リファクタリング中に新しいテストを追加すること（それは TDD の領域）

## コミットルール

- コミットメッセージテンプレート（推奨）:
  - `refactor: <対象> — <改善内容>`
  - 例: `refactor: ProfileList — extract renderProfileCard helper function`
  - 例: `refactor: organization schema — rename organizationId to orgId for consistency`

## 変更検証とエビデンス

- Agent は各ステップのテスト結果を作業証跡として `serena/*` に記録する。
- 記録内容: 変更前のテスト結果、変更後のテスト結果、lint/build 結果。

## Serena ツール活用ガイド

リファクタリングでは以下の Serena ツールが特に有用です：

| ツール                                         | 用途                           |
| ---------------------------------------------- | ------------------------------ |
| `get_symbols_overview`                         | ファイル内のシンボル一覧を取得 |
| `find_symbol`                                  | 特定シンボルの詳細を取得       |
| `find_referencing_symbols`                     | シンボルの参照箇所を特定       |
| `rename_symbol`                                | シンボル名を安全にリネーム     |
| `replace_symbol_body`                          | シンボルの実装を置換           |
| `insert_before_symbol` / `insert_after_symbol` | シンボルの前後にコードを挿入   |

## 完了条件

以下のすべてを満たした場合にリファクタリング完了とする：

- [ ] 開始時に全テストが GREEN だった
- [ ] 完了時に全テストが GREEN である
- [ ] lint エラーがない
- [ ] build が成功する
- [ ] 振る舞い（外部仕様）が変わっていない
- [ ] 作業ログを `serena/*` に記録した
